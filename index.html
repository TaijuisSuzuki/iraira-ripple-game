<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Iraira Ripple Game – Global Ranking Edition</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<!-- ───────── CSS ───────── -->
<style>
/* ==== 全体リセット & 縁取り無効 ==== */
html,body,canvas,#game,.screen{margin:0;padding:0;border:none!important;outline:none!important;box-shadow:none!important;background:#111;color:#fff;font-family:sans-serif}

/* ===== 上部インジケータ ===== */
#ui{position:fixed;top:6px;left:50%;transform:translateX(-50%);z-index:5;font-size:20px;text-align:center;pointer-events:none}

/* ===== イライラメーター ===== */
#meterWrap{position:fixed;top:36px;left:50%;transform:translateX(-50%);width:80%;max-width:560px;height:12px;background:#555;border-radius:6px;z-index:5}
#meterBar{height:100%;width:0;background:#ff3333;border-radius:6px;transition:width .1s linear}

/* ===== 画面共通 ===== */
.screen{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;background:rgba(0,0,0,.85);z-index:20;overflow-y:auto;-webkit-overflow-scrolling:touch;animation:fade .4s forwards}
@keyframes fade{from{opacity:0}to{opacity:1}}
.screen h1{font-size:64px;margin:8vh 0 20px;text-align:center}

/* ボタン */
.btn{font-size:28px;padding:12px 48px;border:none;border-radius:8px;background:#e22;color:#fff;cursor:pointer}
.btn:hover{background:#ff4444}

/* ===== キャラクター／アイテム紹介 ===== */
.char-list{display:flex;flex-wrap:wrap;justify-content:center;gap:36px;max-width:760px;margin-bottom:28px}
.char{width:130px;text-align:center}
.char img{width:96px;height:96px;object-fit:cover;border-radius:50%;border:2px solid #fff;}
.char-name{font-weight:bold;margin-top:6px;font-size:16px}
.char-desc{font-size:13px;line-height:1.4}

/* ユーザー名入力 */
#nameWrap{display:flex;flex-direction:column;align-items:center;margin-top:20px}
#userName{font-size:22px;padding:6px 10px;border-radius:6px;border:none;width:220px;text-align:center}

/* ===== ランキング表 ===== */
table{border-collapse:collapse;color:#fff;margin-top:12px}
td,th{padding:4px 10px;border-bottom:1px solid #444;text-align:center}

/* GAME OVER メッセージ */
.meeting{font-size:24px;margin:4px 0 24px;color:#ffcc00}

/* モバイル用調整 */
@media(max-width:640px){
  .screen h1{font-size:48px}
  table{font-size:14px}
  .btn{font-size:24px;padding:10px 36px}
  #ui{font-size:18px}
}
</style>
<!-- ───────── CSS ここまで ───────── -->
</head>

<body>
<canvas id="game"></canvas>

<!-- UI / メーター -->
<div id="ui" style="display:none">Loading…</div>
<div id="meterWrap" style="display:none"><div id="meterBar"></div></div>

<!-- ① キャラクター＆アイテム紹介 -->
<div id="charScreen" class="screen" style="display:none">
  <h1>CHARACTER INTRODUCTION</h1>
  <div class="char-list">
    <div class="char"><img src="img/player.png"><div class="char-name">You</div><div class="char-desc">マウスで操作。</div></div>
    <div class="char"><img src="img/ishibesawa.png"><div class="char-name">石部砂羽</div><div class="char-desc">イライラオーラに触れると<br>大家くん召喚。</div></div>
    <div class="char"><img src="img/ohyakaisei.png"><div class="char-name">大家くん</div><div class="char-desc">接触で❤−1。</div></div>
    <div class="char"><img src="img/cigarette.png"><div class="char-name">タバコ</div><div class="char-desc">オーラ20％減<br>+200点</div></div>
    <div class="char"><img src="img/beer.png"><div class="char-name">ビール</div><div class="char-desc">オーラ20％減<br>+200点</div></div>
    <div class="char"><img src="img/tenga.png"><div class="char-name">テンガ</div><div class="char-desc">オーラ0％<br>+500点</div></div>
  </div>

  <div id="nameWrap">
    <input id="userName" type="text" placeholder="Your name" maxlength="16">
    <small style="margin-top:6px;font-size:14px;color:#ccc">※16文字以内・未入力なら Anonymous</small>
  </div>

  <button id="toRuleBtn" class="btn">NEXT</button>
</div>

<!-- ② ルール -->
<div id="ruleScreen" class="screen" style="display:none">
  <h1>HOW TO PLAY</h1>
  <p style="max-width:640px;font-size:18px;line-height:1.5;margin:0 20px 36px;text-align:left">
    ● マウスでプレイヤーを操作。<br>
    ● イライラオーラは時間とともに拡大。石部砂羽が触れると大家くん(最大3体)が出現。<br>
    ● 大家くんに接触すると❤が1減り、3回でゲームオーバー。<br>
    ● タバコ / ビール：オーラを20％減少 &amp; +200点。<br>
    ● テンガ：オーラを0％にして +500点。<br>
    ● 生存1秒ごと+10点。20秒ごとにLvUP。<br>
    Enjoy!
  </p>
  <button id="startBtn" class="btn">START</button>
</div>

<!-- ③ GAME OVER ＆ ランキング -->
<div id="overlay" class="screen" style="display:none">
  <h1>GAME OVER</h1>
  <p id="finalScore"></p>
  <p id="meetingMsg" class="meeting"></p>

  <h2>GLOBAL RANKING TOP 5</h2>
  <table>
    <thead><tr><th>RANK</th><th>NAME</th><th>SCORE</th><th>DATE</th></tr></thead>
    <tbody id="rankBody"></tbody>
  </table>

  <button id="retry" class="btn" style="margin-top:24px">Retry</button>
</div>

<!-- ───────── JavaScript ───────── -->
<script type="module">
/* ========== 0. 基本設定 ========== */
const IS_MOBILE = window.matchMedia('(max-width:640px)').matches;
const SCALE = IS_MOBILE ? 1.3 : 1.0;

/* スコア閾値 */
const THRESHOLD = 5000;
const MSG_WIN  = '大矢君との1on1ミーティング回避成功!!';
const MSG_LOSE = '大家くんとの1on1ミーティング開催決定!!';

/* ========== 1. Firebase（省略: 必要なら以前のキーをそのまま） ========== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs }
  from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAOgz1m_HNI670w567SMRCqWDIM7JJsAhU",
  authDomain: "ishibesawa-ranking.firebaseapp.com",
  projectId: "ishibesawa-ranking",
  storageBucket: "ishibesawa-ranking.appspot.com",
  messagingSenderId: "1083315491931",
  appId: "1:1083315491931:web:ca5a01a9ba8d80cec45b7e",
  measurementId: "G-MQDR6D367N"
};
const appFB = initializeApp(firebaseConfig);
const db    = getFirestore(appFB);
const col   = collection(db,"scores");

/* ========== 2. 画像ロード ========== */
const IMG_PATHS={
  player:'img/player.png',
  ishibe:'img/ishibesawa.png',
  ohya:'img/ohyakaisei.png',
  cig:'img/cigarette.png',
  beer:'img/beer.png',
  tenga:'img/tenga.png'
};
const IMAGES={};
const loadImages=()=>Promise.all(Object.entries(IMG_PATHS).map(([k,src])=>new Promise((ok,ng)=>{
  const i=new Image();i.onload=()=>{IMAGES[k]=i;ok();};i.onerror=ng;i.src=src;
})));

/* ========== 3. 定数 / ユーティリティ ========== */
const MIN_AURA=14*SCALE, MAX_AURA=200*SCALE, ITEM_INTERVAL=3000, MAX_OHYA=3;
const cvs=document.querySelector('canvas'),ctx=cvs.getContext('2d');
function resize(){cvs.width=innerWidth;cvs.height=innerHeight;} resize();addEventListener('resize',resize);
let mouse={x:innerWidth/2,y:innerHeight/2};
cvs.onmousemove=e=>{const r=cvs.getBoundingClientRect();mouse.x=e.clientX-r.left;mouse.y=e.clientY-r.top;};
cvs.ontouchmove=e=>{e.preventDefault();const r=cvs.getBoundingClientRect();mouse.x=e.touches[0].clientX-r.left;mouse.y=e.touches[0].clientY-r.top;},{passive:false};
const dist=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
const drawCenter=(img,x,y,r)=>{const s=r*2/img.width;ctx.save();ctx.translate(x,y);ctx.scale(s,s);ctx.drawImage(img,-img.width/2,-img.height/2);ctx.restore();};

/* パーティクル */
const particles=[];
function spawnParticles(x,y,col){for(let i=0;i<18;i++)particles.push({x,y,life:600,vx:(Math.random()-0.5)*4,vy:(Math.random()-0.5)*4,col});}
function updateParticles(dt){for(const p of particles){p.x+=p.vx;p.y+=p.vy;p.life-=dt;}while(particles.length&&particles[0].life<=0)particles.shift();}
function drawParticles(){for(const p of particles){ctx.fillStyle=p.col.replace('{a}',(p.life/600).toFixed(2));ctx.fillRect(p.x,p.y,4,4);}}

/* ========== 4. エンティティ ========== */
class Player{constructor(){this.r=34*SCALE;this.x=cvs.width/2;this.y=cvs.height/2;}update(){this.x=mouse.x;this.y=mouse.y;}draw(){drawCenter(IMAGES.player,this.x,this.y,this.r);}}
class Ishibesawa{
  constructor(spd){this.r=28*SCALE;this.x=Math.random()*cvs.width;this.y=Math.random()*cvs.height;this.speed=spd;this.dirTimer=0;this.cd=1500;this.turn();}
  turn(){const a=Math.random()*Math.PI*2;this.vx=Math.cos(a)*this.speed;this.vy=Math.sin(a)*this.speed;}
  levelUp(){this.speed+=0.5;}
  update(dt){this.dirTimer+=dt;if(this.dirTimer>this.cd){this.dirTimer=0;this.turn();}this.x+=this.vx;this.y+=this.vy;
    if(this.x<this.r){this.x=this.r;this.vx=Math.abs(this.vx);}if(this.x>cvs.width-this.r){this.x=cvs.width-this.r;this.vx=-Math.abs(this.vx);}
    if(this.y<this.r){this.y=this.r;this.vy=Math.abs(this.vy);}if(this.y>cvs.height-this.r){this.y=cvs.height-this.r;this.vy=-Math.abs(this.vy);}}
  draw(){drawCenter(IMAGES.ishibe,this.x,this.y,this.r);}
}
class Ohyakaisei{
  constructor(x,y,spd){this.r=34*SCALE;this.x=x;this.y=y;this.speed=spd;this.life=5000;}
  levelUp(){this.speed+=1;}
  update(p,dt){const dx=p.x-this.x,dy=p.y-this.y,l=Math.hypot(dx,dy)||1;this.x+=dx/l*this.speed;this.y+=dy/l*this.speed;this.life-=dt;}
  draw(){drawCenter(IMAGES.ohya,this.x,this.y,this.r);}
}
class Aura{
  constructor(p){this.p=p;this.r=MIN_AURA;this.speed=0.02*SCALE;}
  levelUp(){this.speed+=0.003*SCALE;}
  update(dt){this.r+=this.speed*dt;this.x=this.p.x;this.y=this.p.y;}
  draw(){ctx.save();ctx.translate(this.x,this.y);const g=ctx.createRadialGradient(0,0,this.r*0.8,0,0,this.r);
    g.addColorStop(0,'rgba(255,0,0,0)');g.addColorStop(1,'rgba(255,0,0,.5)');ctx.fillStyle=g;ctx.beginPath();ctx.arc(0,0,this.r,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='rgba(255,0,0,.9)';ctx.lineWidth=2;ctx.beginPath();ctx.arc(0,0,this.r,0,Math.PI*2);ctx.stroke();ctx.restore();}
}
class Item{
  constructor(tp){this.type=tp;this.r=24*SCALE;this.x=Math.random()*cvs.width;this.y=Math.random()*cvs.height;}
  draw(){const k=this.type==='cig'?'cig':this.type==='beer'?'beer':'tenga';drawCenter(IMAGES[k],this.x,this.y,this.r);}
  update(){}
}

/* ========== 5. ゲームステート ========== */
let player,aura,ishibe,ohy,items,state,timer,last,score,lv,lifecnt,itemTimer;
const ui=document.getElementById('ui'),meterWrap=document.getElementById('meterWrap'),meterBar=document.getElementById('meterBar');
const overlay=document.getElementById('overlay'),finalScore=document.getElementById('finalScore'),rankBody=document.getElementById('rankBody'),meetingMsg=document.getElementById('meetingMsg');

function updateUI(){ui.textContent=`Time:${(timer/1000).toFixed(1)}  Score:${Math.floor(score)}  ❤${'❤'.repeat(lifecnt)}  Lv:${lv}`;}
function updateMeter(){const p=Math.min(1,Math.max(0,(aura.r-MIN_AURA)/(MAX_AURA-MIN_AURA)));meterBar.style.width=`${p*100}%`;}

/* ゲーム初期化 */
function initGame(){
  player=new Player();aura=new Aura(player);ishibe=new Ishibesawa(4);ohy=[];items=[];
  state='PLAYING';timer=score=0;lv=1;lifecnt=3;itemTimer=0;last=undefined;
  overlay.style.display='none';ui.style.display='block';meterWrap.style.display='block';
  updateUI();updateMeter();requestAnimationFrame(loop);
}
function spawnOhya(){if(ohy.length>=MAX_OHYA)return;const m=40,e=Math.floor(Math.random()*4);let x,y;
  if(e===0){x=Math.random()*cvs.width;y=-m;}else if(e===1){x=cvs.width+m;y=Math.random()*cvs.height;}
  else if(e===2){x=Math.random()*cvs.width;y=cvs.height+m;}else{x=-m;y=Math.random()*cvs.height;}
  ohy.push(new Ohyakaisei(x,y,ishibe.speed*3));
}
function levelUp(){lv++;ishibe.levelUp();aura.levelUp();ohy.forEach(o=>o.levelUp());}

/* メインループ */
function loop(t){if(state!=='GAMEOVER')requestAnimationFrame(loop);const dt=t-(last??t);last=t;update(dt);draw();}
function update(dt){
  if(state!=='PLAYING')return;
  timer+=dt;score+=dt*0.01;
  player.update();aura.update(dt);ishibe.update(dt);updateParticles(dt);
  if(Math.floor(timer/20000)+1>lv)levelUp();

  /* アイテム生成 */
  itemTimer+=dt;
  if(itemTimer>ITEM_INTERVAL){itemTimer=0;
    const r=Math.random();items.push(new Item(r<0.45?'cig':r<0.9?'beer':'tenga'));
  }

  /* アイテム取得 */
  items=items.filter(it=>{
    if(dist(it,player)<it.r+player.r){
      if(it.type==='tenga'){aura.r=MIN_AURA;score+=500;spawnParticles(it.x,it.y,'rgba(255,0,255,{a})');}
      else{aura.r=Math.max(MIN_AURA,aura.r*0.8);score+=200;spawnParticles(it.x,it.y,'rgba(0,255,255,{a})');}
      return false;
    }return true;
  });

  if(dist(ishibe,player)<aura.r+ishibe.r)spawnOhya();
  ohy=ohy.filter(o=>{
    o.update(player,dt);
    if(o.life<=0){spawnParticles(o.x,o.y,'rgba(255,255,0,{a})');return false;}
    if(dist(o,player)<o.r+player.r){lifecnt--;spawnParticles(o.x,o.y,'rgba(255,64,64,{a})');return false;}
    return true;
  });

  if(lifecnt<=0)gameOver();
  updateUI();updateMeter();
}
function draw(){
  ctx.clearRect(0,0,cvs.width,cvs.height);
  aura.draw();player.draw();ishibe.draw();items.forEach(i=>i.draw());ohy.forEach(o=>o.draw());drawParticles();
}

/* ゲームオーバー */
async function gameOver(){
  state='GAMEOVER';ui.style.display='none';meterWrap.style.display='none';
  const sc=Math.floor(score);finalScore.textContent=`SCORE : ${sc}`;meetingMsg.textContent=sc>=THRESHOLD?MSG_WIN:MSG_LOSE;
  overlay.style.display='flex';
  try{await addDoc(col,{score:sc,name:userName,ts:Date.now()});
    const snap=await getDocs(query(col,orderBy("score","desc"),limit(5)));
    rankBody.innerHTML=snap.docs.map((d,i)=>{const v=d.data();return`<tr><td>${i+1}</td><td>${(v.name||'---').replace(/</g,'&lt;')}</td><td>${v.score}</td><td>${new Date(v.ts).toLocaleString()}</td></tr>`;}).join("")||`<tr><td colspan="4">No record</td></tr>`;
  }catch(e){console.error(e);rankBody.innerHTML=`<tr><td colspan="4">Error</td></tr>`;}
}

/* 入力・ボタン */
let userName="Anonymous";
document.getElementById('userName').oninput=e=>userName=e.target.value.trim()||"Anonymous";
document.getElementById('toRuleBtn').onclick=()=>{userName=document.getElementById('userName').value.trim()||"Anonymous";document.getElementById('charScreen').style.display='none';document.getElementById('ruleScreen').style.display='flex';};
document.getElementById('startBtn').onclick=()=>{document.getElementById('ruleScreen').style.display='none';initGame();};
document.getElementById('retry').onclick=()=>{overlay.style.display='none';initGame();};

/* 起動 */
loadImages().then(()=>document.getElementById('charScreen').style.display='flex');
</script>
<!-- ───────── JavaScript ここまで ───────── -->
</body>
</html>
