<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Iraira Ripple Game – Global Ranking Edition</title>
<style>
  /* ===== 全体レイアウト ===== */
  html,body{margin:0;padding:0;overflow:hidden;background:#111;color:#fff;font-family:sans-serif}
  #ui{position:fixed;top:10px;left:50%;transform:translateX(-50%);z-index:5;font-size:22px;text-align:center;pointer-events:none}

  /* ===== 画面共通 ===== */
  .screen{position:fixed;inset:0;display:flex;flex-direction:column;justify-content:flex-start;align-items:center;
          background:rgba(0,0,0,.85);z-index:20;animation:fade .4s forwards}
  @keyframes fade{from{opacity:0}to{opacity:1}}
  .screen h1{font-size:64px;margin:8vh 0 20px;text-align:center}
  .btn{font-size:28px;padding:12px 48px;border:none;border-radius:8px;background:#e22;color:#fff;cursor:pointer}
  .btn:hover{background:#ff4444}

  /* ===== キャラクター紹介 ===== */
  .char-list{display:flex;flex-wrap:wrap;justify-content:center;gap:36px;max-width:680px;margin-bottom:28px}
  .char{width:130px;text-align:center}
  .char img{width:96px;height:96px;object-fit:cover;border-radius:50%;border:2px solid #fff;}
  .char-name{font-weight:bold;margin-top:6px;font-size:16px}
  .char-desc{font-size:13px;line-height:1.4}

  /* ===== ランキング表 ===== */
  table{border-collapse:collapse;color:#fff;margin-top:12px}
  td,th{padding:4px 10px;border-bottom:1px solid #444;text-align:center}

  /* ===== GAME OVER 追加文 ===== */
  .meeting{font-size:24px;margin:4px 0 24px;color:#ffcc00}
</style>
</head>
<body>
<canvas id="game"></canvas>

<!-- ===== ゲーム上部 UI ===== -->
<div id="ui" style="display:none">Loading…</div>

<!-- ① キャラクター紹介画面 -->
<div id="charScreen" class="screen" style="display:none">
  <h1>CHARACTER&nbsp;INTRODUCTION</h1>
  <div class="char-list">
    <div class="char">
      <img src="img/player.png" alt="Player">
      <div class="char-name">You</div>
      <div class="char-desc">マウスで操作。</div>
    </div>
    <div class="char">
      <img src="img/ishibesawa.png" alt="Ishibesawa">
      <div class="char-name">石部沢</div>
      <div class="char-desc">赤オーラに触れると<br>大家くん召喚。</div>
    </div>
    <div class="char">
      <img src="img/ohyakaisei.png" alt="Ohya">
      <div class="char-name">大家くん</div>
      <div class="char-desc">接触で❤−1。</div>
    </div>
  </div>
  <button id="toRuleBtn" class="btn">NEXT</button>
</div>

<!-- ② ルール説明画面 -->
<div id="ruleScreen" class="screen" style="display:none">
  <h1>HOW&nbsp;TO&nbsp;PLAY</h1>
  <p style="max-width:640px;font-size:18px;line-height:1.5;margin:0 20px 36px;text-align:left">
    ● マウスでプレイヤーを操作。<br>
    ● 赤いオーラは時間とともに拡大。石部沢が触れると大家くん(最大3体)が出現。<br>
    ● 大家くんに接触すると❤が1減り、3回でゲームオーバー。<br>
    ● タバコ / ビールを取るとオーラ半減 &amp; +200点。<br>
    ● 生存1秒ごと+10点。20秒ごとにLvUP。<br>
    Enjoy!
  </p>
  <button id="startBtn" class="btn">START</button>
</div>

<!-- ③ GAME OVER + ランキング画面 -->
<div id="overlay" class="screen" style="display:none">
  <h1>GAME&nbsp;OVER</h1>
  <p id="finalScore"></p>
  <!-- ★ 追加メッセージ（改行なし） -->
  <p class="meeting">大家くんとの1on1ミーティング開催決定!!</p>

  <h2>GLOBAL&nbsp;RANKING&nbsp;TOP&nbsp;10</h2>
  <table><tbody id="rankBody"></tbody></table>

  <button id="retry" class="btn" style="margin-top:24px">Retry</button>
</div>

<script type="module">
/* ===================================================================
   0. Firebase 初期化 & Firestore 関数
   ===================================================================*/
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc,
         query, orderBy, limit, getDocs }
  from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAOgz1m_HNI670w567SMRCqWDIM7JJsAhU",
  authDomain: "ishibesawa-ranking.firebaseapp.com",
  projectId: "ishibesawa-ranking",
  storageBucket: "ishibesawa-ranking.appspot.com",
  messagingSenderId: "1083315491931",
  appId: "1:1083315491931:web:ca5a01a9ba8d80cec45b7e",
  measurementId: "G-MQDR6D367N"
};
const appFB = initializeApp(firebaseConfig);
const db    = getFirestore(appFB);
const col   = collection(db,"scores");

const saveScore = async s => {
  try{ await addDoc(col,{score:s,ts:Date.now()}); }
  catch(e){ console.error("saveScore failed:",e); }
};
const loadTop10 = async () =>
  (await getDocs(query(col,orderBy("score","desc"),limit(10)))).docs.map(d=>d.data());

/* ===================================================================
   1. 画像ロード
   ===================================================================*/
const IMG_PATHS = {
  player :'img/player.png',
  ishibe :'img/ishibesawa.png',
  ohya   :'img/ohyakaisei.png',
  cig    :'img/cigarette.png',
  beer   :'img/beer.png'
};
const IMAGES = {};
function loadImages(){
  return Promise.all(Object.entries(IMG_PATHS).map(([k,src])=>new Promise((ok,ng)=>{
    const img=new Image();
    img.onload = ()=>{ IMAGES[k]=img; ok(); };
    img.onerror= ng;
    img.src    = src;
  })));
}

/* ===================================================================
   2. Canvas & ユーティリティ
   ===================================================================*/
const cvs=document.getElementById('game'),ctx=cvs.getContext('2d');
function resize(){cvs.width=innerWidth;cvs.height=innerHeight;} resize();
addEventListener('resize',resize);

let mouse={x:innerWidth/2,y:innerHeight/2};
cvs.onmousemove=e=>{const r=cvs.getBoundingClientRect(); mouse.x=e.clientX-r.left; mouse.y=e.clientY-r.top;};
cvs.ontouchmove=e=>{e.preventDefault(); const r=cvs.getBoundingClientRect(); mouse.x=e.touches[0].clientX-r.left; mouse.y=e.touches[0].clientY-r.top;},{passive:false};

const dist=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
const drawCenter=(img,x,y,r)=>{
  const s=r*2/img.width;
  ctx.save();
  ctx.translate(x,y);
  ctx.scale(s,s);
  ctx.drawImage(img,-img.width/2,-img.height/2);
  ctx.restore();
};

/* ===================================================================
   3. パーティクル
   ===================================================================*/
const particles=[];
function spawnParticles(x,y,col){
  for(let i=0;i<18;i++){
    particles.push({x,y,life:600,vx:(Math.random()-0.5)*4,vy:(Math.random()-0.5)*4,col});
  }
}
function updateParticles(dt){
  for(const p of particles){ p.x+=p.vx; p.y+=p.vy; p.life-=dt; }
  while(particles.length && particles[0].life<=0) particles.shift();
}
function drawParticles(){
  for(const p of particles){
    ctx.fillStyle=p.col.replace('{a}',(p.life/600).toFixed(2));
    ctx.fillRect(p.x,p.y,4,4);
  }
}

/* ===================================================================
   4. エンティティクラス
   ===================================================================*/
class Player{
  constructor(){ this.r=34; this.x=cvs.width/2; this.y=cvs.height/2; }
  update(){ this.x=mouse.x; this.y=mouse.y; }
  draw() { drawCenter(IMAGES.player,this.x,this.y,this.r); }
}

class Ishibesawa{
  constructor(spd){
    this.r=28;
    this.x=Math.random()*cvs.width;
    this.y=Math.random()*cvs.height;
    this.speed=spd;
    this.dirTimer=0; this.cd=1500;
    this.turn();
  }
  turn(){ const a=Math.random()*Math.PI*2; this.vx=Math.cos(a)*this.speed; this.vy=Math.sin(a)*this.speed; }
  levelUp(){ this.speed+=0.5; }
  update(dt){
    this.dirTimer+=dt;
    if(this.dirTimer>this.cd){ this.dirTimer=0; this.turn(); }
    this.x+=this.vx; this.y+=this.vy;
    if(this.x<this.r||this.x>cvs.width-this.r) this.vx*=-1;
    if(this.y<this.r||this.y>cvs.height-this.r) this.vy*=-1;
  }
  draw(){ drawCenter(IMAGES.ishibe,this.x,this.y,this.r); }
}

class Ohyakaisei{
  constructor(x,y,spd){ this.r=34; this.x=x; this.y=y; this.speed=spd; this.life=5000; }
  levelUp(){ this.speed+=1; }
  update(player,dt){
    const dx=player.x-this.x, dy=player.y-this.y, l=Math.hypot(dx,dy)||1;
    this.x+=dx/l*this.speed; this.y+=dy/l*this.speed; this.life-=dt;
  }
  draw(){ drawCenter(IMAGES.ohya,this.x,this.y,this.r); }
}

class Aura{
  constructor(p){ this.p=p; this.r=14; this.speed=0.02; }
  levelUp(){ this.speed+=0.003; }
  update(dt){ this.r+=this.speed*dt; this.x=this.p.x; this.y=this.p.y; }
  draw(){
    ctx.save(); ctx.translate(this.x,this.y);
    const g=ctx.createRadialGradient(0,0,this.r*0.8,0,0,this.r);
    g.addColorStop(0,'rgba(255,0,0,0)'); g.addColorStop(1,'rgba(255,0,0,.5)');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,this.r,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='rgba(255,0,0,.9)'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.arc(0,0,this.r,0,Math.PI*2); ctx.stroke();
    ctx.restore();
  }
}

class Item{
  constructor(tp){ this.type=tp; this.r=24; this.x=Math.random()*cvs.width; this.y=Math.random()*cvs.height; }
  draw(){ drawCenter(this.type==='cig'?IMAGES.cig:IMAGES.beer,this.x,this.y,this.r); }
  update(){}
}

/* ===================================================================
   5. ゲームステート管理
   ===================================================================*/
let player,aura,ishibe,ohy,items,state,timer,last,score,lv,lifecnt,itemTimer;
const ui=document.getElementById('ui'),
      overlay=document.getElementById('overlay'),
      finalScore=document.getElementById('finalScore'),
      rankBody=document.getElementById('rankBody');

const ITEM_INTERVAL=3000, MAX_OHYA=3;

function updateUI(){
  ui.textContent=`Time:${(timer/1000).toFixed(1)}  Score:${Math.floor(score)}  ❤${'❤'.repeat(lifecnt)}  Lv:${lv}`;
}

function initGame(){
  player=new Player();
  aura  =new Aura(player);
  ishibe=new Ishibesawa(4);
  ohy=[]; items=[];
  state='PLAYING';
  timer=score=0; lv=1; lifecnt=3; itemTimer=0; last=undefined;
  overlay.style.display='none';
  ui.style.display='block';
  updateUI();
  requestAnimationFrame(loop);
}

function spawnOhya(){
  if(ohy.length>=MAX_OHYA) return;
  const m=40,e=Math.floor(Math.random()*4);
  let x,y;
  if(e===0){ x=Math.random()*cvs.width; y=-m; }
  else if(e===1){ x=cvs.width+m; y=Math.random()*cvs.height; }
  else if(e===2){ x=Math.random()*cvs.width; y=cvs.height+m; }
  else{ x=-m; y=Math.random()*cvs.height; }
  ohy.push(new Ohyakaisei(x,y,ishibe.speed*3));
}

function levelUp(){
  lv++; ishibe.levelUp(); aura.levelUp(); ohy.forEach(o=>o.levelUp());
}

function loop(t){
  if(state!=='GAMEOVER') requestAnimationFrame(loop);
  const dt = t-(last??t); last=t;
  update(dt); draw();
}

function update(dt){
  if(state!=='PLAYING') return;
  timer+=dt; score+=dt*0.01;

  player.update();
  aura.update(dt);
  ishibe.update(dt);
  updateParticles(dt);

  /* LvUP */
  if(Math.floor(timer/20000)+1>lv) levelUp();

  /* アイテム生成 */
  itemTimer+=dt;
  if(itemTimer>ITEM_INTERVAL){ itemTimer=0; items.push(new Item(Math.random()<.5?'cig':'beer')); }

  /* アイテム取得 */
  items=items.filter(it=>{
    if(dist(it,player)<it.r+player.r){
      aura.r=Math.max(14,aura.r*0.5);
      score+=200;
      spawnParticles(it.x,it.y,'rgba(0,255,255,{a})');
      return false;
    }
    return true;
  });

  /* 石部沢がオーラに触れると大家くん */
  if(dist(ishibe,player)<aura.r+ishibe.r) spawnOhya();

  /* 大家くん処理 */
  ohy=ohy.filter(o=>{
    o.update(player,dt);
    if(o.life<=0){
      spawnParticles(o.x,o.y,'rgba(255,255,0,{a})');
      return false;
    }
    if(dist(o,player)<o.r+player.r){
      lifecnt--;
      spawnParticles(o.x,o.y,'rgba(255,64,64,{a})');
      return false;
    }
    return true;
  });

  if(lifecnt<=0) gameOver();

  updateUI();
}

function draw(){
  ctx.clearRect(0,0,cvs.width,cvs.height);
  aura.draw();
  player.draw();
  ishibe.draw();
  items.forEach(i=>i.draw());
  ohy.forEach(o=>o.draw());
  drawParticles();
}

/* ===================================================================
   6. ゲームオーバー & ランキング
   ===================================================================*/
function setRanking(arr){
  rankBody.innerHTML = arr.map((e,i)=>`<tr><td>${i+1}</td><td>${e.score}</td><td>${new Date(e.ts).toLocaleString()}</td></tr>`)
                          .join("") || `<tr><td colspan=3>No record</td></tr>`;
}

function gameOver(){
  state='GAMEOVER';
  ui.style.display='none';
  const sc=Math.floor(score);
  finalScore.textContent=`SCORE : ${sc}`;
  overlay.style.display='flex';
  saveScore(sc)
    .then(loadTop10)
    .then(setRanking)
    .catch(e=>{console.error(e); setRanking([]);});
}

/* ===================================================================
   7. 画面遷移ボタン
   ===================================================================*/
document.getElementById('toRuleBtn').onclick = ()=>{
  document.getElementById('charScreen').style.display='none';
  document.getElementById('ruleScreen').style.display='flex';
};
document.getElementById('startBtn').onclick  = ()=>{
  document.getElementById('ruleScreen').style.display='none';
  initGame();
};
document.getElementById('retry').onclick     = ()=>{
  overlay.style.display='none';
  initGame();
};

/* ===================================================================
   8. 起動
   ===================================================================*/
loadImages().then(()=>{
  document.getElementById('charScreen').style.display='flex';
});
</script>
</body>
</html>
