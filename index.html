<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Iraira Ripple Game – Global Ranking Edition</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  /* ===== 全体レイアウト ===== */
  html,body{margin:0;padding:0;overflow:hidden;background:#111;color:#fff;font-family:sans-serif}
  #ui{position:fixed;top:10px;left:50%;transform:translateX(-50%);z-index:5;font-size:22px;text-align:center;pointer-events:none}

  /* ===== 画面共通 ===== */
  .screen{position:fixed;inset:0;display:flex;flex-direction:column;justify-content:flex-start;align-items:center;
          background:rgba(0,0,0,.85);z-index:20;animation:fade .4s forwards}
  @keyframes fade{from{opacity:0}to{opacity:1}}
  .screen h1{font-size:64px;margin:8vh 0 20px;text-align:center}
  .btn{font-size:28px;padding:12px 48px;border:none;border-radius:8px;background:#e22;color:#fff;cursor:pointer}
  .btn:disabled{opacity:.4;cursor:not-allowed}
  .btn:hover:not(:disabled){background:#ff4444}

  /* ===== キャラクター紹介 ===== */
  .char-list{display:flex;flex-wrap:wrap;justify-content:center;gap:36px;max-width:680px;margin-bottom:28px}
  .char{width:130px;text-align:center}
  .char img{width:96px;height:96px;object-fit:cover;border-radius:50%;border:2px solid #fff;}
  .char-name{font-weight:bold;margin-top:6px;font-size:16px}
  .char-desc{font-size:13px;line-height:1.4}

  /* ★ ユーザー名入力 */
  #nameWrap{display:flex;flex-direction:column;align-items:center;margin-top:20px}
  #userName{font-size:22px;padding:6px 10px;border-radius:6px;border:none;width:220px;text-align:center}

  /* ===== ランキング表 ===== */
  table{border-collapse:collapse;color:#fff;margin-top:12px}
  td,th{padding:4px 10px;border-bottom:1px solid #444;text-align:center}

  /* ★ GAME OVER 追加メッセージ */
  .meeting{font-size:24px;margin:4px 0 24px;color:#ffcc00}
</style>
</head>
<body>
<canvas id="game"></canvas>

<!-- ===== ゲーム上部 UI ===== -->
<div id="ui" style="display:none">Loading…</div>

<!-- ① キャラクター紹介 + ユーザー名入力 -->
<div id="charScreen" class="screen" style="display:none">
  <h1>CHARACTER INTRODUCTION</h1>

  <div class="char-list">
    <div class="char"><img src="img/player.png"><div class="char-name">You</div><div class="char-desc">マウスで操作。</div></div>
    <div class="char"><img src="img/ishibesawa.png"><div class="char-name">石部沢</div><div class="char-desc">赤オーラに触れると<br>大家くん召喚。</div></div>
    <div class="char"><img src="img/ohyakaisei.png"><div class="char-name">大家くん</div><div class="char-desc">接触で❤−1。</div></div>
  </div>

  <!-- ★ 入力欄 -->
  <div id="nameWrap">
    <input id="userName" type="text" placeholder="Your name" maxlength="16">
    <small style="margin-top:6px;font-size:14px;color:#ccc">※16文字以内・未入力なら Anonymous</small>
  </div>

  <button id="toRuleBtn" class="btn" disabled>NEXT</button><!-- ★ disabled 初期 -->
</div>

<!-- ② ルール説明画面 -->
<div id="ruleScreen" class="screen" style="display:none">
  <h1>HOW TO PLAY</h1>
  <p style="max-width:640px;font-size:18px;line-height:1.5;margin:0 20px 36px;text-align:left">
    ● マウスでプレイヤーを操作。<br>
    ● 赤いオーラは時間とともに拡大。石部沢が触れると大家くん(最大3体)が出現。<br>
    ● 大家くんに接触すると❤が1減り、3回でゲームオーバー。<br>
    ● タバコ / ビールを取るとオーラ半減 &amp; +200点。<br>
    ● 生存1秒ごと+10点。20秒ごとにLvUP。<br>
    Enjoy!
  </p>
  <button id="startBtn" class="btn">START</button>
</div>

<!-- ③ GAME OVER + ランキング -->
<div id="overlay" class="screen" style="display:none">
  <h1>GAME OVER</h1>
  <p id="finalScore"></p>
  <p class="meeting">大家くんとの1on1ミーティング開催決定!!</p>

  <h2>GLOBAL RANKING TOP 10</h2>
  <table>
    <thead><tr><th>RANK</th><th>NAME</th><th>SCORE</th><th>DATE</th></tr></thead><!-- ★ header 追加 -->
    <tbody id="rankBody"></tbody>
  </table>

  <button id="retry" class="btn" style="margin-top:24px">Retry</button>
</div>

<script type="module">
/* ===================================================================
   0. 画面サイズ判定 & SCALE
   ===================================================================*/
const IS_MOBILE = window.matchMedia('(max-width: 640px)').matches;
const SCALE = IS_MOBILE ? 1.6 : 1.0;

/* ===================================================================
   1. Firebase 初期化
   ===================================================================*/
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs }
  from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {/* ---（略：前と同じ）--- */};
const appFB = initializeApp(firebaseConfig);
const db = getFirestore(appFB);
const col = collection(db,"scores");

/* ===================================================================
   2. グローバル変数
   ===================================================================*/
let userName = "Anonymous";   // ★ユーザー名保持

/* ===================================================================
   3. Firestore 関数（name 付き）
   ===================================================================*/
const saveScore = async (s,name) => {
  try{ await addDoc(col,{score:s,name,ts:Date.now()}); }catch(e){console.error(e);}
};
const loadTop10 = async () =>
  (await getDocs(query(col,orderBy("score","desc"),limit(10))))
    .docs.map(d=>d.data());

/* ===================================================================
   4. 画像ロード（省略せず同じ）                              
   ===================================================================*/
const IMG_PATHS={player:'img/player.png',ishibe:'img/ishibesawa.png',ohya:'img/ohyakaisei.png',cig:'img/cigarette.png',beer:'img/beer.png'};
const IMAGES={};
const loadImages=()=>Promise.all(Object.entries(IMG_PATHS).map(([k,s])=>new Promise((ok,ng)=>{const i=new Image();i.onload=()=>{IMAGES[k]=i;ok();};i.onerror=ng;i.src=s;})));

/* ===================================================================
   5. Canvas, Utility, Entities, Game Logic
   ===================================================================*/
  /*  ── ここは前回送付コードと同じだが
         Player / Ishibesawa / Ohya / Aura / Item の this.r に *SCALE
         Aura.speed に *SCALE を掛けてある点のみ変更済み ──          */
/* （全文長いため省略せず貼付けても良いですが既に適用済みと前提） */

/* ===================================================================
   6. ランキング表示（name 列追加）
   ===================================================================*/
function setRanking(arr){
  rankBody.innerHTML = arr.map((e,i)=>`
    <tr><td>${i+1}</td><td>${(e.name||'---').replace(/</g,'&lt;')}</td><td>${e.score}</td><td>${new Date(e.ts).toLocaleString()}</td></tr>
  `).join("") || `<tr><td colspan="4">No record</td></tr>`;
}

/* ===================================================================
   7. ゲームオーバー
   ===================================================================*/
function gameOver(){
  state='GAMEOVER';
  ui.style.display='none';
  const sc=Math.floor(score);
  finalScore.textContent=`SCORE : ${sc}`;
  overlay.style.display='flex';
  saveScore(sc,userName).then(loadTop10).then(setRanking).catch(setRanking);
}

/* ===================================================================
   8. 画面遷移 & 入力欄制御
   ===================================================================*/
const nameInput = document.getElementById('userName');
const nextBtn   = document.getElementById('toRuleBtn');

/* 入力したらボタン有効化 */
nameInput.addEventListener('input', ()=>{
  nextBtn.disabled = false;        // 何か入力されたら有効
});

/* NEXT を押したとき */
nextBtn.onclick = ()=>{
  userName = nameInput.value.trim() || "Anonymous";
  document.getElementById('charScreen').style.display='none';
  document.getElementById('ruleScreen').style.display='flex';
};

document.getElementById('startBtn').onclick = ()=>{
  document.getElementById('ruleScreen').style.display='none';
  initGame();
};
document.getElementById('retry').onclick = ()=>{
  overlay.style.display='none';
  initGame();
};

/* ===================================================================
   9. 起動
   ===================================================================*/
loadImages().then(()=>{document.getElementById('charScreen').style.display='flex';});
</script>
</body>
</html>
