<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Iraira Ripple Game – Global Ranking Edition</title>
<style>
  html,body{margin:0;padding:0;overflow:hidden;background:#111;color:#fff;font-family:sans-serif}
  #ui{position:fixed;top:10px;left:50%;transform:translateX(-50%);z-index:5;font-size:22px;text-align:center;pointer-events:none}

  .screen{position:fixed;inset:0;display:flex;flex-direction:column;justify-content:flex-start;align-items:center;
          background:rgba(0,0,0,.85);z-index:20;animation:fade .4s forwards}
  @keyframes fade{from{opacity:0}to{opacity:1}}
  .screen h1{font-size:64px;margin:8vh 0 20px;text-align:center}
  .screen p{max-width:680px;font-size:20px;line-height:1.5;margin:0 20px 32px;text-align:left}
  .btn{font-size:32px;padding:14px 60px;border:none;border-radius:8px;background:#e22;color:#fff;cursor:pointer}
  .btn:hover{background:#ff4444}
  table{border-collapse:collapse;color:#fff;margin-top:12px}
  td,th{padding:4px 10px;border-bottom:1px solid #444;text-align:center}
</style>
</head>
<body>
<canvas id="game"></canvas>

<!-- 上部 UI -->
<div id="ui" style="display:none">Loading…</div>

<!-- タイトル画面 -->
<div id="startScreen" class="screen">
  <h1>Iraira Ripple Game – Plus</h1>
  <p>
    【ルール】マウスでプレイヤーを操作しハイスコアを目指せ！<br>
    ・オーラが石部沢に触れると大家くん(Ohya)が出現<br>
    ・Ohya に当たると❤減少（3 回で終了）<br>
    ・タバコ/ビール取得でオーラ半減 +200 点<br>
    ・20 秒ごとに LvUP（速度上昇）
  </p>
  <button id="startBtn" class="btn">START</button>
</div>

<!-- GAME OVER + ランキング画面 -->
<div id="overlay" class="screen" style="display:none">
  <h1>GAME&nbsp;OVER</h1>
  <p id="finalScore"></p>

  <h2>GLOBAL&nbsp;RANKING&nbsp;TOP&nbsp;10</h2>
  <table id="rankTable"><tbody id="rankBody"></tbody></table>

  <button id="retry" class="btn" style="margin-top:28px">Retry</button>
</div>

<!-- =================== すべて ES Module で記述 =================== -->
<script type="module">
/* ---------- 1. Firebase SDK 読み込み ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, addDoc,
  query, orderBy, limit, getDocs
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* Firebase 設定（コンソールからコピペ） */
const firebaseConfig = {
  apiKey: "AIzaSyAOgz1m_HNI670w567SMRCqWDIM7JJsAhU",
  authDomain: "ishibesawa-ranking.firebaseapp.com",
  projectId: "ishibesawa-ranking",
  storageBucket: "ishibesawa-ranking.appspot.com",
  messagingSenderId: "1083315491931",
  appId: "1:1083315491931:web:ca5a01a9ba8d80cec45b7e",
  measurementId: "G-MQDR6D367N"
};

const appFB = initializeApp(firebaseConfig);
const db    = getFirestore(appFB);
const col   = collection(db,"scores");

/* スコアを保存 */
async function saveScore(score){
  try{ await addDoc(col,{score,ts:Date.now()}); }
  catch(e){ console.error("saveScore failed",e); }
}

/* TOP10 を取得 */
async function loadTop10(){
  const snap = await getDocs(query(col,orderBy("score","desc"),limit(10)));
  return snap.docs.map(d=>d.data());  // [{score,ts},…]
}

/* ---------- 2. 画像ロード ---------- */
const IMG_PATHS={
  player:'img/player.png',
  ishibe:'img/ishibesawa.png',
  ohya  :'img/ohyakaisei.png',
  cig   :'img/cigarette.png',
  beer  :'img/beer.png'
};
const IMAGES={};
function loadImages(){return Promise.all(Object.entries(IMG_PATHS).map(([k,s])=>new Promise((ok,ng)=>{
  const i=new Image();i.onload=()=>{IMAGES[k]=i;ok();};i.onerror=ng;i.src=s;
})));}

/* ---------- 3. Canvas & 汎用関数 ---------- */
const cvs=document.getElementById('game'),ctx=cvs.getContext('2d');
function resize(){cvs.width=innerWidth;cvs.height=innerHeight;}resize();
addEventListener('resize',resize);
let mouse={x:innerWidth/2,y:innerHeight/2};
cvs.onmousemove=e=>{const r=cvs.getBoundingClientRect();mouse.x=e.clientX-r.left;mouse.y=e.clientY-r.top;};
cvs.ontouchmove=e=>{e.preventDefault();const r=cvs.getBoundingClientRect();mouse.x=e.touches[0].clientX-r.left;mouse.y=e.touches[0].clientY-r.top;},{passive:false};
const dist=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
const drawCenter=(img,x,y,r)=>{const s=r*2/img.width;ctx.save();ctx.translate(x,y);ctx.scale(s,s);ctx.drawImage(img,-img.width/2,-img.height/2);ctx.restore();};

/* ---------- 4. パーティクル ---------- */
const particles=[];
function spawnParticles(x,y,col){for(let i=0;i<18;i++)particles.push({x,y,life:600,vx:(Math.random()-0.5)*4,vy:(Math.random()-0.5)*4,col});}
function updateParticles(dt){for(const p of particles){p.x+=p.vx;p.y+=p.vy;p.life-=dt;}while(particles.length&&particles[0].life<=0)particles.shift();}
function drawParticles(){for(const p of particles){ctx.fillStyle=p.col.replace('{a}',(p.life/600).toFixed(2));ctx.fillRect(p.x,p.y,4,4);}}

/* ---------- 5. クラス定義 ---------- */
class Player{constructor(){this.r=34;this.x=cvs.width/2;this.y=cvs.height/2;}update(){this.x=mouse.x;this.y=mouse.y;}draw(){drawCenter(IMAGES.player,this.x,this.y,this.r);}}
class Ishibesawa{
  constructor(spd){this.r=28;this.x=Math.random()*cvs.width;this.y=Math.random()*cvs.height;this.speed=spd;this.dirTimer=0;this.cd=1500;this.turn();}
  turn(){const a=Math.random()*Math.PI*2;this.vx=Math.cos(a)*this.speed;this.vy=Math.sin(a)*this.speed;}
  levelUp(){this.speed+=0.5;}
  update(dt){this.dirTimer+=dt;if(this.dirTimer>this.cd){this.dirTimer=0;this.turn();}
    this.x+=this.vx;this.y+=this.vy;if(this.x<this.r||this.x>cvs.width-this.r)this.vx*=-1;
    if(this.y<this.r||this.y>cvs.height-this.r)this.vy*=-1;}
  draw(){drawCenter(IMAGES.ishibe,this.x,this.y,this.r);}
}
class Ohyakaisei{
  constructor(x,y,spd){this.r=34;this.x=x;this.y=y;this.speed=spd;this.life=5000;}
  levelUp(){this.speed+=1;}
  update(p,dt){const dx=p.x-this.x,dy=p.y-this.y,l=Math.hypot(dx,dy)||1;this.x+=dx/l*this.speed;this.y+=dy/l*this.speed;this.life-=dt;}
  draw(){drawCenter(IMAGES.ohya,this.x,this.y,this.r);}
}
class Aura{
  constructor(p){this.p=p;this.r=14;this.speed=0.02;}
  levelUp(){this.speed+=0.003;}
  update(dt){this.r+=this.speed*dt;this.x=this.p.x;this.y=this.p.y;}
  draw(){ctx.save();ctx.translate(this.x,this.y);
    const g=ctx.createRadialGradient(0,0,this.r*0.8,0,0,this.r);g.addColorStop(0,'rgba(255,0,0,0)');g.addColorStop(1,'rgba(255,0,0,.5)');
    ctx.fillStyle=g;ctx.beginPath();ctx.arc(0,0,this.r,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='rgba(255,0,0,.9)';ctx.lineWidth=2;ctx.beginPath();ctx.arc(0,0,this.r,0,Math.PI*2);ctx.stroke();ctx.restore();}
}
class Item{constructor(tp){this.type=tp;this.r=24;this.x=Math.random()*cvs.width;this.y=Math.random()*cvs.height;}draw(){drawCenter(this.type==='cig'?IMAGES.cig:IMAGES.beer,this.x,this.y,this.r);}update(){}}

/* ---------- 6. ゲームステート ---------- */
let player,aura,ishibe,ohy,items,state,timer,last,score,lv,lifecnt,itemTimer;
const ui=document.getElementById('ui'),overlay=document.getElementById('overlay'),
      finalScore=document.getElementById('finalScore'),startScreen=document.getElementById('startScreen'),
      rankBody=document.getElementById('rankBody');

const ITEM_INTERVAL=3000,MAX_OHYA=3;

function initGame(){
  player=new Player();aura=new Aura(player);ishibe=new Ishibesawa(4);
  ohy=[];items=[];state='PLAYING';timer=score=0;lv=1;lifecnt=3;itemTimer=0;last=undefined;
  overlay.style.display='none';ui.style.display='block';updateUI();requestAnimationFrame(loop);
}

function updateUI(){ui.textContent=`Time:${(timer/1000).toFixed(1)}  Score:${Math.floor(score)}  ❤${'❤'.repeat(lifecnt)}  Lv:${lv}`;}

function spawnOhya(){if(ohy.length>=MAX_OHYA)return;const m=40,e=Math.floor(Math.random()*4);let x,y;
  if(e===0){x=Math.random()*cvs.width;y=-m;}else if(e===1){x=cvs.width+m;y=Math.random()*cvs.height;}
  else if(e===2){x=Math.random()*cvs.width;y=cvs.height+m;}else{x=-m;y=Math.random()*cvs.height;}
  ohy.push(new Ohyakaisei(x,y,ishibe.speed*3));}

function levelUp(){lv++;ishibe.levelUp();aura.levelUp();ohy.forEach(o=>o.levelUp());}

function loop(t){if(state!=='GAMEOVER')requestAnimationFrame(loop);const dt=t-(last??t);last=t;update(dt);draw();}

function update(dt){
  if(state!=='PLAYING')return;
  timer+=dt;score+=dt*0.01;
  player.update();aura.update(dt);ishibe.update(dt);updateParticles(dt);

  if(Math.floor(timer/20000)+1>lv)levelUp();

  itemTimer+=dt;if(itemTimer>ITEM_INTERVAL){itemTimer=0;items.push(new Item(Math.random()<.5?'cig':'beer'));}

  items=items.filter(it=>{if(dist(it,player)<it.r+player.r){aura.r=Math.max(14,aura.r*0.5);score+=200;spawnParticles(it.x,it.y,'rgba(0,255,255,{a})');return false;}return true;});

  if(dist(ishibe,player)<aura.r+ishibe.r)spawnOhya();

  ohy=ohy.filter(o=>{
    o.update(player,dt);
    if(o.life<=0){spawnParticles(o.x,o.y,'rgba(255,255,0,{a})');return false;}
    if(dist(o,player)<o.r+player.r){lifecnt--;spawnParticles(o.x,o.y,'rgba(255,64,64,{a})');return false;}
    return true;
  });

  if(lifecnt<=0)gameOver();updateUI();
}

function draw(){ctx.clearRect(0,0,cvs.width,cvs.height);aura.draw();player.draw();ishibe.draw();items.forEach(i=>i.draw());ohy.forEach(o=>o.draw());drawParticles();}

/* --- ランキング表組み立て --- */
function setRankingTable(arr){
  rankBody.innerHTML = arr.map((e,i)=>`<tr><td>${i+1}</td><td>${e.score}</td><td>${new Date(e.ts).toLocaleString()}</td></tr>`).join("")
                       || `<tr><td colspan=3>No record yet</td></tr>`;
}

/* --- GAME OVER 処理 --- */
function gameOver(){
  state='GAMEOVER';ui.style.display='none';
  const sc=Math.floor(score);
  finalScore.textContent=`SCORE : ${sc}`;
  overlay.style.display='flex';

  // 1) 保存 → 2) 取得 → 3) 表示
  saveScore(sc)
    .then(loadTop10)
    .then(setRankingTable)
    .catch(e=>{console.error(e);setRankingTable([]);});
}

/* --- ボタン --- */
document.getElementById('retry').onclick=()=>{overlay.style.display='none';initGame();};
document.getElementById('startBtn').onclick=()=>{startScreen.style.display='none';initGame();};

/* ---------- 7. 起動 ---------- */
loadImages().then(()=>{startScreen.style.display='flex';});
</script>
</body>
</html>
