<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Iraira Ripple Game</title>
<style>
  html,body{margin:0;padding:0;overflow:hidden;background:#111;color:#fff;font-family:sans-serif}
  #ui{position:fixed;top:10px;left:10px;z-index:10}
  h1{font-size:18px;margin:0 0 4px}
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="ui">
  <h1 id="status">Loading…</h1>
  <button id="retry" style="display:none">Retry</button>
</div>

<script>
//==============================//
// 1. 画像プリロード
//==============================//
const IMG_PATHS={
  player:'img/player.png',
  ishibe:'img/ishibesawa.png',
  ohya  :'img/ohyakaisei.png',
  cig   :'img/cigarette.png',
  beer  :'img/beer.png'
};
const IMAGES={};
function loadImages(obj){
  return Promise.all(Object.entries(obj).map(([k,src])=>new Promise((res,rej)=>{
    const img=new Image();
    img.onload=()=>{IMAGES[k]=img;res();}
    img.onerror=()=>{console.error('Load Err',src);rej(src);}
    img.src=src;
  })));
}

//==============================//
// 2. Canvas & 共通
//==============================//
const cvs=document.getElementById('game');
const ctx=cvs.getContext('2d');
function resize(){cvs.width=innerWidth;cvs.height=innerHeight;}
addEventListener('resize',resize);resize();

let mouse={x:cvs.width/2,y:cvs.height/2};
cvs.onmousemove=e=>{const r=cvs.getBoundingClientRect();
  mouse.x=e.clientX-r.left;mouse.y=e.clientY-r.top;};
cvs.ontouchmove=e=>{e.preventDefault();const r=cvs.getBoundingClientRect();
  mouse.x=e.touches[0].clientX-r.left;mouse.y=e.touches[0].clientY-r.top;},{passive:false};

const dist=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
function drawCenter(img,x,y,r){
  const s=(r*2)/img.width;
  ctx.save();ctx.translate(x,y);ctx.scale(s,s);
  ctx.drawImage(img,-img.width/2,-img.height/2);ctx.restore();
}

//==============================//
// 3. クラス
//==============================//
class Player{
  constructor(){
    this.r=24;
    this.x=cvs.width/2;
    this.y=cvs.height/2;
  }
  update(){
    this.x=mouse.x;this.y=mouse.y;
  }
  draw(){drawCenter(IMAGES.player,this.x,this.y,this.r);}
}

class Ishibesawa{
  constructor(){this.r=20;this.x=50;this.y=50;}
  update(p){
    const e=.03;
    this.x+=(p.x-this.x)*e;
    this.y+=(p.y-this.y)*e;
  }
  draw(){drawCenter(IMAGES.ishibe,this.x,this.y,this.r);}
}

class Ohyakaisei{
  constructor(x,y){this.r=24;this.x=x;this.y=y;this.speed=2;}
  update(p){
    const dx=p.x-this.x,dy=p.y-this.y,l=Math.hypot(dx,dy)||1;
    this.x+=dx/l*this.speed;this.y+=dy/l*this.speed;
  }
  draw(){drawCenter(IMAGES.ohya,this.x,this.y,this.r);}
}

// イライラ波（最大120px、ゆっくり拡大）
class AngerWave{
  constructor(x,y,startR){
    this.x=x;this.y=y;
    this.r=startR;
    this.speed=0.08;          // px / ms  （0.08 ⇒ 約5倍遅い）
    this.maxR=120;            // プレイヤー周囲だけ
  }
  update(dt){
    this.r+=this.speed*dt;
    return this.r<this.maxR;
  }
  draw(){
    ctx.save();ctx.translate(this.x,this.y);
    const g=ctx.createRadialGradient(0,0,0,0,0,this.r);
    g.addColorStop(0.0,'rgba(255,80,80,0.6)');
    g.addColorStop(0.5,'rgba(255,0,0,0.35)');
    g.addColorStop(1.0,'rgba(255,0,0,0)');
    ctx.fillStyle=g;
    ctx.beginPath();ctx.arc(0,0,this.r,0,Math.PI*2);ctx.fill();
    ctx.restore();
  }
}

class Item{
  constructor(tp){
    this.type=tp;this.r=20;
    this.x=Math.random()*cvs.width;
    this.y=Math.random()*cvs.height;
  }
  update(){}
  draw(){drawCenter(this.type==='cig'?IMAGES.cig:IMAGES.beer,
                    this.x,this.y,this.r);}
}

//==============================//
// 4. ゲーム変数
//==============================//
let player,ishibe,ohya,waves,items;
let timer,state,waveTimer,itemTimer;
let waveStartR,loopLast;

const WAVE_INTERVAL=1200;      // 波が出る間隔を長めに
const WAVE_MIN=4,WAVE_INC=2,WAVE_MAX=60; // startR 管理だけ
const ITEM_INTERVAL=10000;

//==============================//
// 5. ゲームループ
//==============================//
function init(){
  player=new Player();
  ishibe=new Ishibesawa();
  waves=[];items=[];ohya=null;
  timer=0;state='PLAYING';
  waveTimer=itemTimer=0;waveStartR=WAVE_MIN;
  document.getElementById('retry').style.display='none';
  loopLast=undefined;
  requestAnimationFrame(loop);
}

function loop(t){
  if(state!=='GAMEOVER')requestAnimationFrame(loop);
  const dt=t-(loopLast??t);loopLast=t;
  update(dt);draw();
}

function update(dt){
  timer+=dt;
  player.update();ishibe.update(player);

  // 波紋生成
  waveTimer+=dt;
  if(waveTimer>WAVE_INTERVAL){
    waveTimer=0;
    waves.push(new AngerWave(player.x,player.y,waveStartR));
    waveStartR=Math.min(waveStartR+WAVE_INC,WAVE_MAX);
  }
  waves=waves.filter(w=>w.update(dt));

  // アイテム生成
  itemTimer+=dt;
  if(itemTimer>ITEM_INTERVAL){
    itemTimer=0;items.push(new Item(Math.random()<.5?'cig':'beer'));
  }

  // アイテム取得
  items=items.filter(it=>{
    if(dist(it,player)<it.r+player.r){
      waveStartR=Math.max(WAVE_MIN,waveStartR-15);
      return false;
    }return true;
  });

  // 波紋→ishibesawa
  if(state==='PLAYING'&&waves.some(w=>dist(w,ishibe)<w.r)){
    state='CHASE';spawnOhya();
  }

  // ohya 追跡
  if(state==='CHASE'){
    ohya.update(player);
    if(dist(ohya,player)<ohya.r+player.r){state='GAMEOVER';gameOver();}
  }
}

function spawnOhya(){
  const e=Math.floor(Math.random()*4);let x,y;
  if(e===0){x=Math.random()*cvs.width;y=-40;}
  if(e===1){x=cvs.width+40;y=Math.random()*cvs.height;}
  if(e===2){x=Math.random()*cvs.width;y=cvs.height+40;}
  if(e===3){x=-40;y=Math.random()*cvs.height;}
  ohya=new Ohyakaisei(x,y);
}

function draw(){
  ctx.clearRect(0,0,cvs.width,cvs.height);
  waves.forEach(w=>w.draw());
  items.forEach(i=>i.draw());
  player.draw();ishibe.draw();
  if(state!=='PLAYING'&&ohya)ohya.draw();
  document.getElementById('status').textContent=
    (state==='GAMEOVER'?'Final ':'Time: ')+(timer/1000).toFixed(1)+'s';
}

function gameOver(){
  document.getElementById('retry').style.display='inline';
}

document.getElementById('retry').onclick=init;

//==============================//
// 6. 起動
//==============================//
loadImages(IMG_PATHS).then(()=>{
  document.getElementById('status').textContent='Time: 0.0s';
  init();
});
</script>
</body>
</html>
