<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Iraira Ripple Game – Global Ranking Edition</title>
<meta name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">

<style>
/* ────────── 基本レイアウト ────────── */
html,body{margin:0;height:100%;background:#111;color:#fff;font-family:sans-serif}
canvas{display:block;position:fixed;inset:0;width:100%;height:100%}

/* ────────── UIバー & メーター ────────── */
#ui{position:fixed;top:6px;left:50%;transform:translateX(-50%);
    font-size:20px;pointer-events:none;z-index:5}
#meterWrap{position:fixed;top:36px;left:50%;transform:translateX(-50%);
           width:80%;max-width:560px;height:12px;background:#555;border-radius:6px;z-index:5}
#meterBar{height:100%;width:0;background:#ff3333;border-radius:6px;transition:width .1s linear}

/* ────────── フルスクリーン画面 ────────── */
.screen{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;
        background:rgba(0,0,0,.85);overflow-y:auto;-webkit-overflow-scrolling:touch;
        animation:fade .4s forwards;min-height:100vh;z-index:20}
@keyframes fade{from{opacity:0}to{opacity:1}}
.screen h1{font-size:64px;margin:8vh 0 20px;text-align:center}

/* ────────── ボタン & 表 ────────── */
.btn{font-size:28px;padding:12px 48px;border:none;border-radius:8px;background:#e22;color:#fff;cursor:pointer}
.btn:hover{background:#ff4444}
table{border-collapse:collapse;color:#fff;margin-top:12px}
td,th{padding:4px 10px;border-bottom:1px solid #444;text-align:center}
.meeting{font-size:24px;margin:4px 0 24px;color:#ffcc00}

/* ────────── キャラ & アイテム紹介 ────────── */
.char-list{display:flex;flex-wrap:wrap;justify-content:center;gap:36px;max-width:760px;margin-bottom:28px}
.char{width:130px;text-align:center}
.char img{width:96px;height:96px;object-fit:cover;border-radius:50%;border:2px solid #fff}
.char-name{font-weight:bold;margin-top:6px;font-size:16px}
.char-desc{font-size:13px;line-height:1.4}

/* ────────── 入力欄 ────────── */
#nameWrap{display:flex;flex-direction:column;align-items:center;margin-top:20px}
#userName{font-size:22px;padding:6px 10px;border-radius:6px;border:none;width:220px;text-align:center}

/* ────────── モバイル文字調整 ────────── */
@media(max-width:640px){
  .screen h1{font-size:48px}
  table{font-size:14px}
  .btn{font-size:24px;padding:10px 36px}
  #ui{font-size:18px}
}
</style>
</head>

<body>
<canvas id="game"></canvas>

<div id="ui" style="display:none">Loading…</div>
<div id="meterWrap" style="display:none"><div id="meterBar"></div></div>

<!-- ① キャラクター紹介 / 難易度選択 -->
<div id="charScreen" class="screen">
  <h1>CHARACTER INTRODUCTION</h1>
  <div class="char-list">
    <div class="char"><img src="img/player.png"><div class="char-name">You</div><div class="char-desc">マウス / 指で操作</div></div>
    <div class="char"><img src="img/ishibesawa.png"><div class="char-name">石部砂羽</div><div class="char-desc">オーラに触れると大家くん召喚</div></div>
    <div class="char"><img src="img/ohyakaisei.png"><div class="char-name">大家くん</div><div class="char-desc">接触で ❤ −1</div></div>
    <div class="char"><img src="img/cigarette.png"><div class="char-name">タバコ</div><div class="char-desc">オーラ半減 +200pt</div></div>
    <div class="char"><img src="img/beer.png"><div class="char-name">ビール</div><div class="char-desc">オーラ半減 +200pt</div></div>
    <div class="char"><img src="img/tenga.png"><div class="char-name">テンガ</div><div class="char-desc">オーラ0% +500pt</div></div>
  </div>

  <div id="nameWrap">
    <input id="userName" type="text" placeholder="Your name" maxlength="16">
    <small style="margin-top:6px;font-size:14px;color:#ccc">※16文字以内・未入力なら Anonymous</small>
  </div>

  <div id="diffWrap" style="margin:18px 0;font-size:20px">
    DIFFICULTY:
    <label style="margin:0 10px"><input type="radio" name="diff" value="EASY">EASY</label>
    <label style="margin:0 10px"><input type="radio" name="diff" value="NORMAL" checked>NORMAL</label>
    <label style="margin:0 10px"><input type="radio" name="diff" value="HARD">HARD</label>
  </div>

  <button id="toRuleBtn" class="btn">NEXT</button>
</div>

<!-- ② ルール -->
<div id="ruleScreen" class="screen" style="display:none">
  <h1>HOW TO PLAY</h1>
  <p style="max-width:640px;font-size:18px;line-height:1.5;margin:0 20px 36px;text-align:left">
    ● プレイヤーをマウス / 指で操作。<br>
    ● オーラは時間とともに拡大し、石部砂羽が触れると大家くんが増える。<br>
    ● タバコ / ビール：オーラ半減＋200pt。<br>
    ● テンガ：オーラ 0% ＋500pt。<br>
    ● 1秒ごと +10pt、20秒ごとに LvUP（石部砂羽のみ加速）。<br>
    ● 難易度で大家くん上限・アイテム確率が変化。Enjoy!
  </p>
  <button id="startBtn" class="btn">START</button>
</div>

<!-- ③ GAME OVER -->
<div id="overlay" class="screen" style="display:none">
  <h1>GAME OVER</h1>
  <p id="finalScore"></p>
  <p id="yourRank" style="font-size:22px;margin:6px 0 18px"></p><!-- ← 自分の順位 -->
  <p id="meetingMsg" class="meeting"></p>

  <h2>GLOBAL RANKING TOP 5</h2>
  <table>
    <thead><tr><th>RANK</th><th>NAME</th><th>SCORE</th><th>DATE</th></tr></thead>
    <tbody id="rankBody"></tbody>
  </table>

  <button id="retry" class="btn" style="margin-top:24px">Retry</button>
  <button id="topBtn" class="btn" style="margin-top:12px">TOP</button>
</div>

<!-- ────────── JavaScript ────────── -->
<script type="module">
/* ==== 0. 定数・難易度設定 ==== */
const SCALE=1.0,THRESHOLD=5000,
      MSG_WIN='大家くんとの1on1ミーティング回避成功!!',
      MSG_LOSE='大家くんとの1on1ミーティング開催決定!!';
const DIFF_CFG={
  EASY  :{max:2,prob:{t:0.25,c:0.375,b:0.375}},
  NORMAL:{max:3,prob:{t:0.20,c:0.40 ,b:0.40 }},
  HARD  :{max:4,prob:{t:0.15,c:0.425,b:0.425}}
};
let diff='NORMAL',CFG=DIFF_CFG[diff];

/* ==== 1. Firebase ==== */
import{initializeApp}from"https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import{
  getFirestore,collection,addDoc,query,orderBy,limit,getDocs,where,
  getCountFromServer            /* ← 集計 API */
}from"https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
initializeApp({
  apiKey:"AIzaSyAOgz1m_HNI670w567SMRCqWDIM7JJsAhU",
  authDomain:"ishibesawa-ranking.firebaseapp.com",
  projectId:"ishibesawa-ranking",
  storageBucket:"ishibesawa-ranking.appspot.com",
  messagingSenderId:"1083315491931",
  appId:"1:1083315491931:web:ca5a01a9ba8d80cec45b7e"});
const db=getFirestore(),COL=collection(db,"scores");

/* ==== 2. 画像ロード ==== */
const PATH={player:'img/player.png',ishibe:'img/ishibesawa.png',ohya:'img/ohyakaisei.png',
            cig:'img/cigarette.png',beer:'img/beer.png',tenga:'img/tenga.png'};
const IMG={};
await Promise.all(Object.entries(PATH).map(([k,s])=>new Promise((ok,ng)=>{
  const i=new Image();i.onload=()=>{IMG[k]=i;ok();};i.onerror=ng;i.src=s;
})));

/* ==== 3. Canvas & 汎用描画 ==== */
const cvs=document.getElementById('game'),ctx=cvs.getContext('2d');
function resize(){cvs.width=innerWidth;cvs.height=(visualViewport?visualViewport.height:innerHeight);}resize();
addEventListener('resize',resize);addEventListener('orientationchange',()=>setTimeout(resize,200));

function drawCircle(img,x,y,r){
  ctx.save();ctx.translate(x,y);
  ctx.beginPath();ctx.arc(0,0,r,0,Math.PI*2);ctx.clip();
  const s=r*2/img.width;ctx.scale(s,s);ctx.drawImage(img,-img.width/2,-img.height/2);
  ctx.restore();
  ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.stroke();
}

let mouse={x:innerWidth/2,y:innerHeight/2};
cvs.onmousemove=e=>{const r=cvs.getBoundingClientRect();mouse.x=e.clientX-r.left;mouse.y=e.clientY-r.top;};
cvs.ontouchmove=e=>{e.preventDefault();const r=cvs.getBoundingClientRect();mouse.x=e.touches[0].clientX-r.left;mouse.y=e.touches[0].clientY-r.top;},{passive:false};
const dist=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y);

/* ==== 4. パーティクル ==== */
const PT=[];function spark(x,y,c){for(let i=0;i<18;i++)PT.push({x,y,vx:(Math.random()-.5)*4,vy:(Math.random()-.5)*4,l:600,c});}
function updPT(dt){for(const p of PT){p.x+=p.vx;p.y+=p.vy;p.l-=dt;}while(PT[0]&&PT[0].l<=0)PT.shift();}
function drwPT(){for(const p of PT){ctx.fillStyle=p.c.replace('{a}',(p.l/600).toFixed(2));ctx.fillRect(p.x,p.y,4,4);}}

/* ==== 5. エンティティ ==== */
class Player{constructor(){this.r=34*SCALE;this.x=cvs.width/2;this.y=cvs.height/2;}upd(){this.x=mouse.x;this.y=mouse.y;}drw(){drawCircle(IMG.player,this.x,this.y,this.r);}}
class Ishibe{
  constructor(s){this.r=28*SCALE;this.x=Math.random()*cvs.width;this.y=Math.random()*cvs.height;this.s=s;this.t=0;this.cd=1500;this.turn();}
  turn(){const a=Math.random()*6.28;this.vx=Math.cos(a)*this.s;this.vy=Math.sin(a)*this.s;}
  lvUp(){this.s+=.5;}
  upd(dt){this.t+=dt;if(this.t>this.cd){this.t=0;this.turn();}this.x+=this.vx;this.y+=this.vy;
    if(this.x<this.r){this.x=this.r;this.vx=Math.abs(this.vx);}if(this.x>cvs.width-this.r){this.x=cvs.width-this.r;this.vx=-Math.abs(this.vx);}
    if(this.y<this.r){this.y=this.r;this.vy=Math.abs(this.vy);}if(this.y>cvs.height-this.r){this.y=cvs.height-this.r;this.vy=-Math.abs(this.vy);}}
  drw(){drawCircle(IMG.ishibe,this.x,this.y,this.r);}
}
class Ohya{
  constructor(x,y,s){this.r=34*SCALE;this.x=x;this.y=y;this.s=s;this.life=5000;}
  upd(p,dt){const dx=p.x-this.x,dy=p.y-this.y,l=Math.hypot(dx,dy)||1;this.x+=dx/l*this.s;this.y+=dy/l*this.s;this.life-=dt;}
  drw(){drawCircle(IMG.ohya,this.x,this.y,this.r);}
}
class Aura{
  constructor(p){this.p=p;this.r=14*SCALE;this.spd=.02*SCALE;}
  upd(dt){this.r+=this.spd*dt;this.x=this.p.x;this.y=this.p.y;}
  drw(){ctx.save();ctx.translate(this.x,this.y);
    const g=ctx.createRadialGradient(0,0,this.r*.8,0,0,this.r);
    g.addColorStop(0,'rgba(255,0,0,0)');g.addColorStop(1,'rgba(255,0,0,.5)');
    ctx.fillStyle=g;ctx.beginPath();ctx.arc(0,0,this.r,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='rgba(255,0,0,.9)';ctx.lineWidth=2;ctx.beginPath();ctx.arc(0,0,this.r,0,Math.PI*2);ctx.stroke();
    ctx.restore();}
}
class Item{
  constructor(t){this.type=t;this.r=24*SCALE;this.x=Math.random()*cvs.width;this.y=Math.random()*cvs.height;}
  drw(){drawCircle(IMG[this.type],this.x,this.y,this.r);}
}

/* ==== 6. ゲームステート ==== */
let player,aura,ishibe,ohy,items,state,timer,last,score,lv,hp,itT;
const ui=document.getElementById('ui'),meterWrap=document.getElementById('meterWrap'),meterBar=document.getElementById('meterBar');
const overlay=document.getElementById('overlay'),finalScore=document.getElementById('finalScore'),
      rankBody=document.getElementById('rankBody'),meetingMsg=document.getElementById('meetingMsg'),
      yourRank=document.getElementById('yourRank');
function uiUpd(){ui.textContent=`Time:${(timer/1000).toFixed(1)}  Score:${Math.floor(score)}  ❤${'❤'.repeat(hp)}  Lv:${lv}`;}
function meterUpd(){meterBar.style.width=`${Math.min(1,Math.max(0,(aura.r-14*SCALE)/(200*SCALE-14*SCALE)))*100}%`;}

/* ==== 7. 難易度適用 ==== */
function setDiff(){CFG=DIFF_CFG[diff];}

/* ==== 8. ゲーム開始 ==== */
function init(){
  setDiff();
  player=new Player();aura=new Aura(player);ishibe=new Ishibe(4);
  ohy=[];items=[];state='PLAY';timer=score=0;lv=1;hp=3;itT=0;last=undefined;
  overlay.style.display='none';ui.style.display='block';meterWrap.style.display='block';
  uiUpd();meterUpd();requestAnimationFrame(loop);
}
function spawnOhya(){
  if(ohy.length>=CFG.max)return;
  const m=40,e=Math.floor(Math.random()*4);let x,y;
  if(e===0){x=Math.random()*cvs.width;y=-m;}
  else if(e===1){x=cvs.width+m;y=Math.random()*cvs.height;}
  else if(e===2){x=Math.random()*cvs.width;y=cvs.height+m;}
  else{x=-m;y=Math.random()*cvs.height;}
  ohy.push(new Ohya(x,y,ishibe.s*2.3));
}
function levelUp(){lv++;ishibe.lvUp();}

/* ==== 9. メインループ ==== */
function loop(t){
  if(state!=='PLAY')return;
  requestAnimationFrame(loop);
  const dt=t-(last??t);last=t;

  timer+=dt;score+=dt*.01;
  player.upd();aura.upd(dt);ishibe.upd(dt);updPT(dt);
  if(Math.floor(timer/20000)+1>lv)levelUp();

  /* アイテム生成 */
  itT+=dt;
  if(itT>3000){
    itT=0;
    const r=Math.random();let tp='beer';
    if(r<CFG.prob.t)tp='tenga';
    else if(r<CFG.prob.t+CFG.prob.c)tp='cig';
    items.push(new Item(tp));
  }

  /* アイテム取得 */
  items=items.filter(it=>{
    if(dist(it,player)<it.r+player.r){
      if(it.type==='tenga'){aura.r=14*SCALE;score+=500;spark(it.x,it.y,'rgba(255,0,255,{a})');}
      else{aura.r=Math.max(14*SCALE,aura.r*.5);score+=200;spark(it.x,it.y,'rgba(0,255,255,{a})');}
      return false;
    }
    return true;
  });

  /* 石部砂羽との衝突 → 大家くん召喚 */
  if(dist(ishibe,player)<aura.r+ishibe.r)spawnOhya();

  /* 大家くん挙動 */
  ohy=ohy.filter(o=>{
    o.upd(player,dt);
    if(o.life<=0){spark(o.x,o.y,'rgba(255,255,0,{a})');return false;}
    if(dist(o,player)<o.r+player.r){hp--;spark(o.x,o.y,'rgba(255,64,64,{a})');return false;}
    return true;
  });

  /* ゲームオーバー判定 */
  if(hp<=0){gameOver();return;}

  /* 描画 */
  ctx.clearRect(0,0,cvs.width,cvs.height);
  aura.drw();player.drw();ishibe.drw();
  items.forEach(i=>i.drw());ohy.forEach(o=>o.drw());
  drwPT();
  uiUpd();meterUpd();
}

/* ==== 10. GAME OVER ==== */
async function gameOver(){
  state='END';
  ui.style.display='none';meterWrap.style.display='none';
  const sc=Math.floor(score);
  finalScore.textContent=`SCORE : ${sc}`;
  yourRank.textContent='';                             // まず空に
  overlay.style.display='flex';
  rankBody.innerHTML='<tr><td colspan="4">ランキング読み込み中…</td></tr>';

  try{
    /* 1) 保存 */
    await addDoc(COL,{score:sc,name:userName,ts:Date.now()});

    /* 2) TOP 5 */
    const topSnap=await getDocs(query(COL,orderBy("score","desc"),limit(5)));
    rankBody.innerHTML=
      topSnap.docs.map((d,i)=>{
        const v=d.data();return `<tr><td>${i+1}</td>
        <td>${(v.name||'---').replace(/</g,'&lt;')}</td>
        <td>${v.score}</td><td>${new Date(v.ts).toLocaleString()}</td></tr>`;}).join("")
      || `<tr><td colspan="4">No record</td></tr>`;

    /* 3) 自分より高いスコア件数 +1 = 順位 */
    const cnt=await getCountFromServer(query(COL,where("score",">",sc)));
    yourRank.textContent=`YOUR GLOBAL RANK : ${cnt.data().count+1}`;
  }catch(e){
    console.error(e);
    rankBody.innerHTML='<tr><td colspan="4">Error</td></tr>';
    yourRank.textContent='RANK : ―';
  }

  meetingMsg.textContent=sc>=THRESHOLD?MSG_WIN:MSG_LOSE;
}

/* ==== 11. UI ハンドラ ==== */
let userName="Anonymous";
document.getElementById('userName').oninput=e=>userName=e.target.value.trim()||"Anonymous";
document.querySelectorAll('input[name="diff"]').forEach(r=>r.onchange=e=>diff=e.target.value);

document.getElementById('toRuleBtn').onclick=()=>{
  userName=document.getElementById('userName').value.trim()||"Anonymous";
  document.getElementById('charScreen').style.display='none';
  document.getElementById('ruleScreen').style.display='flex';
};
document.getElementById('startBtn').onclick=()=>{
  document.getElementById('ruleScreen').style.display='none';
  init();
};
document.getElementById('retry').onclick=()=>{
  overlay.style.display='none';
  init();
};
document.getElementById('topBtn').onclick=()=>{
  overlay.style.display='none';
  document.getElementById('charScreen').style.display='flex';
};

/* ==== 12. タイトル表示（画像読込済み） ==== */
document.getElementById('charScreen').style.display='flex';
</script>

<!-- ===== ES Modules 非対応ブラウザ向け ===== -->
<script nomodule>
document.body.innerHTML=
'<div style="color:#fff;padding:30px;font-size:20px;line-height:1.6">このブラウザは ES Modules に対応していません。<br>最新版の Chrome / Safari / Edge / Firefox などでご利用ください。</div>';
</script>
</body>
</html>
